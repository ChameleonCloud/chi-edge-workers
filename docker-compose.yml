version: "2.1"

services:
  coordinator:
    build: ./coordinator
    volumes:
      - wireguard_etc:/etc/wireguard
    labels:
      io.balena.features.supervisor-api: "1"
  wireguard:
    build: ./wireguard
    privileged: true
    network_mode: host
    volumes:
      - wireguard_etc:/etc/wireguard
    labels:
      io.balena.features.kernel-modules: "1"
  k3s:
    build: ./k3s
    ulimits:
      nproc: 65535
      nofile:
        soft: 65535
        hard: 65535
    privileged: true
    network_mode: host
    tmpfs:
      - /run/k3s
      # For Calico
      - /run/calico
      - /run/nodeagent
    restart: always
    volumes:
      - k3s_data_dir:/var/lib/rancher/k3s
      - k3s_node_dir:/etc/rancher
      - k3s_kubelet_dir:/var/lib/kubelet # faster startup, resumes state
      # For Calico
      - k3s_libexec_kubernetes_dir:/usr/libexec/kubernetes/ # for calico flexvol startup speedup
      - calico_data_dir:/var/lib/calico
  

volumes:
  k3s_data_dir: {}
  k3s_node_dir: {}
  calico_data_dir: {}
  k3s_kubelet_dir: {}
  k3s_libexec_kubernetes_dir: {}
  wireguard_etc: {}
